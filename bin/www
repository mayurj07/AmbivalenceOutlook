#!/usr/bin/env node
var debug = require('debug')('twitter-stream-globe');
var app = require('../app');
var nconf = require('nconf');
var cluster = require('cluster');

// First, read values from the system environment:
nconf.env();
// You can override system env config values here:
nconf.file({ file: 'config.json' });
// else:
nconf.defaults({
  'PORT': process.env.OPENSHIFT_NODEJS_PORT || process.env.PORT || 3000,
  'BIND_IP': process.env.OPENSHIFT_NODEJS_IP || '0.0.0.0'
});
app.set('port', nconf.get("PORT"));


if(cluster.isMaster) {
    var numWorkers = require('os').cpus().length;

    console.log('Master cluster setting up ' + numWorkers + ' workers...');

    for(var i = 0; i < numWorkers; i++) {
        cluster.fork();
    }

    //cluster.on('online', function(worker) {
    //    console.log('Worker ' + worker.process.pid + ' is online');
    //});

    cluster.on('exit', function(worker, code, signal) {
        console.log('Worker ' + worker.process.pid + ' died with code: ' + code + ', and signal: ' + signal);
        console.log('Starting a new worker');
        cluster.fork();
    });
} else {
    //var app = require('express')();
    //app.all('/*', function(req, res) {res.send('process ' + process.pid + ' says hello!').end();})

    var server = app.listen(nconf.get("PORT"), nconf.get("BIND_IP"), function() {
        console.log('App server listening on '+server.address().address+', port ' + server.address().port);
        console.log('Process ' + process.pid + ' is listening to all incoming requests');
    });

}

console.log('Open: http://localhost:3000/');


